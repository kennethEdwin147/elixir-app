<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @game.name %> - LFG</title>

</head>
<body class="">

<style>
/* ==========================================================================
   #RESET
   ========================================================================== */
*, *::before, *::after {
  box-sizing: border-box;
}

* {
  margin: 0;
  padding: 0;
}

html {
  font-size: 62.5%; /* 1rem = 10px */
}

body {
  font-family: Verdana, Geneva, sans-serif;
  font-size: 13px;
  line-height: 1.4;
  color: #000;
}


img, picture, video, canvas, svg {
  display: block;
  max-width: 100%;
}

input, button, textarea, select {
  font: inherit;
}

a {
  color: inherit;
  text-decoration: none;
}

ul, ol {
  list-style: none;
}

button {
  border: none;
  background: none;
  cursor: pointer;
}
/* ==========================================================================
   END #RESET
========================================================================== */


.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0.5rem;
  background-color: black;
  color: white;
  width: 100%;

  margin-top: 0.75rem;
}

.header-menu {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    max-width: 500px;
}

.header-container {
    max-width: 100vw;
    margin-left: auto;
    margin-right: auto;
    padding-left: 2rem;
    padding-right: 2rem;
}

.container {
    max-width: 92.5vw;
    margin-left: auto;
    margin-right: auto;
}

.game-feed-layout {
    padding-top: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* ==========================================================================
   POST
========================================================================== */

/* ==========================================================================
   POST DÉTAIL
   ========================================================================== */

.post-detail {
  max-width: 95vw;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1rem;
}

.post-main {
  display: flex;
  gap: 0.5rem;
  align-items: flex-start;
}

/* Vote */
.post-vote {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  min-width: 40px;
}

.vote-button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  color: #828282;
  padding: 0;
  line-height: 1;
}

.vote-button:hover {
  color: #ff4655;
}

.vote-count {
  font-size: 11px;
  color: #828282;
}

.vote-button.voted {
  color: #ff4655;
  font-weight: bold;
}

/* Content */
.post-content {
  flex: 1;
}

.post-meta {
  font-size: 11px;
  color: #828282;
  margin-bottom: 0.5rem;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.5rem;
}

.post-meta .author {
  color: #000;
}

.post-description {
  margin-bottom: 0.75rem;
  line-height: 1.5;
  color: #000;
}

.post-contact {
  margin-bottom: 0.75rem;
  font-size: 12px;
  color: #000;
}

.post-contact strong {
  font-weight: 600;
}

.post-link {
  margin-bottom: 0.75rem;
  font-size: 12px;
}

.post-link a {
  color: #9b46ff;
  text-decoration: underline;
}

.post-link a:hover {
  color: #ff4655;
}

/* Tags */
.post-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.tag {
  background-color: #f0f0f0;
  padding: 2px 6px;
  font-size: 11px;
  color: #666;
}

/* Badges type */
.badge.type-lfg {
  background-color: #e8f5e9;
  color: #2e7d32;
}

.badge.type-strat {
  background-color: #e3f2fd;
  color: #1565c0;
}

.badge.type-clip {
  background-color: #f3e5f5;
  color: #7b1fa2;
}

.region {
  font-size: 11px;
  color: #828282;
}

.badge {
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: bold;
}

.badge.plat {
  background-color: #00d4aa;
  color: white;
}

.badge.iron { background-color: #4a4a4a; color: white; }
.badge.bronze { background-color: #cd7f32; color: white; }
.badge.silver { background-color: #c0c0c0; color: black; }
.badge.gold { background-color: #ffd700; color: black; }
.badge.diamond { background-color: #b9f2ff; color: black; }
.badge.ascendant { background-color: #2f5d62; color: white; }
.badge.immortal { background-color: #bb3d65; color: white; }
.badge.radiant { background-color: #ffffaa; color: black; }
.badge.plat { background-color: #00d4aa; color: white; }      /* ← AJOUTE */


.post-meta {
  font-size: 11px;
  color: #828282;
  margin-top: 4px;
}

.delete-link {
  background: none;
  border: none;
  padding: 0;
  color: #828282;
  font-size: 11px;
  cursor: pointer;
  text-decoration: underline;
}

.delete-link:hover {
  color: #ff4655;
}


/* ==========================================================================
   END POST
========================================================================== */


/* ==========================================================================
   COMMENTAIRES
   ========================================================================== */

/* Formulaire principal */
.comment-form {
  max-width: 95vw;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e0e0e0;
}

.comment-form textarea {
  width: 100%;
  max-width: 600px;
  padding: 0.5rem;
  border: 1px solid #ccc;
  font-family: Verdana, Geneva, sans-serif;
  font-size: 13px;
  resize: vertical;
}

.comment-form textarea:focus {
  outline: none;
  border-color: #9b46ff;
}

.comment-form button {
  margin-top: 0.5rem;
  padding: 0.25rem 1rem;
  background-color: #000;
  color: #fff;
  border: none;
  cursor: pointer;
  font-size: 13px;
}

.comment-form button:hover {
  background-color: #333;
}

.comment-form p {
  color: #828282;
  font-size: 13px;
}

.comment-form a {
  color: #9b46ff;
  text-decoration: underline;
}

/* Liste commentaires */
.comments-list {
  max-width: 95vw;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1.5rem;
}

.comments-list-title h2 {
    font-weight: 100;
}

.comments-list h2 {
  font-size: 12px;
  font-weight: 200;
  margin-bottom: 1rem;
}

/* Commentaire individuel */
.comment {
  display: flex;
  gap: 0.5rem;
  align-items: flex-start;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
}

/* Reply indenté */
.replies {
  margin-left: 40px;
  border-left: 1px solid #e0e0e0;
  padding-left: 0.5rem;
}

.comment.reply {
  margin-bottom: 0.75rem;
}

/* Vote commentaire */
.comment-vote {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  min-width: 30px;
}

/* Contenu commentaire */
.comment-content {
  flex: 1;
}

.comment-meta {
  font-size: 11px;
  color: #828282;
  margin-bottom: 0.25rem;
}

.comment-author {
  color: #000;
}

.comment-time {
  margin-left: 0.5rem;
}

.comment-body {
  font-size: 13px;
  line-height: 1.5;
  color: #000;
  margin-bottom: 0.5rem;
}

/* Bouton répondre */
.reply-button {
  font-size: 11px;
  color: #828282;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  text-decoration: underline;
}

.reply-button:hover {
  color: #9b46ff;
}

/* Formulaire de réponse */
.reply-form {
  margin-top: 0.5rem;
  padding: 0.5rem;
  background-color: #f9f9f9;
}

.reply-form textarea {
  width: 100%;
  max-width: 500px;
  padding: 0.5rem;
  border: 1px solid #ccc;
  font-family: Verdana, Geneva, sans-serif;
  font-size: 12px;
}

.reply-form button {
  margin-top: 0.5rem;
  margin-right: 0.5rem;
  padding: 0.25rem 0.75rem;
  background-color: #000;
  color: #fff;
  border: none;
  cursor: pointer;
  font-size: 12px;
}

.reply-form button[type="button"] {
  background-color: #828282;
}

.reply-form button:hover {
  opacity: 0.8;
}

@media screen and (max-width: 600px) {
  .post-vote,
  .comment-vote {
    min-width: 25px;
  }

  .replies {
    margin-left: 20px;
  }

  .comment-form textarea,
  .reply-form textarea {
    max-width: 100%;
  }
}

.vote-button:active {
  transform: scale(0.9);
}

.delete-link {
  background: none;
  border: none;
  padding: 0;
  color: #828282;
  font-size: 11px;
  cursor: pointer;
  text-decoration: underline;
}

.delete-link:hover {
  color: #ff4655;
}

/* ==========================================================================
   END COMMENTAIRES
   ==========================================================================
*/

.dashboard-layout {
    padding-top: 0.5rem;
    display: flex;
    column-gap: 1rem;
}

.dashboard-aside {
    max-width: 150px;

}

</style>

<section class="header header-container">
    <header class="header-menu">
     <a href="/g/<%= @game.slug %>">
        <span class="logo">ValoLFG</span>
     </a>
        <nav>
        nouveau |
        populaire|
        <a href="/g/<%= @game.slug %>/submit">publier</a>
        </nav>
    </header>
    <footer>
    <%= if @current_user do %>
          <form action="/auth/logout" method="post" style="display: inline;">
            <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
            <button type="submit" class="logo" style="background: none; border: none; cursor: pointer; color: inherit; font: inherit;">Déconnexion</button>
        </form>
    <% else %>
        <a href="/auth/login" class="logo">Connexion</a>
    <% end %>
    </footer>
</section>

<main class="container">



<!-- Post détail -->
<section class="post-detail container">
    <article class="post-main">
        <div class="post-vote">
            <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/upvote" method="post">
    <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
    <input type="hidden" name="redirect_to" value="post_detail">
<button type="submit" class="vote-button <%= if MyApp.Services.VoteService.has_voted?(@current_user, "post", @post.id), do: "voted" %>">▲</button>
</form>
            <span class="vote-count"><%= @post.score %></span>
        </div>

        <div class="post-content">
            <div class="post-meta">
                <span class="badge type-<%= @post.type %>"><%= String.upcase(@post.type) %></span>

                <%= if @post.type == "lfg" do %>
                    <span class="badge rank"><%= @post.rank %></span>
                    <span class="region">[<%= @post.region %>]</span>
                <% end %>

                <span class="author">par <%= @post.user.username %></span>
                <span class="time"><%= @post.time_ago %></span>


                  <!-- AJOUTE: Bouton delete -->
                <%= if @current_user && @current_user.id == @post.user_id do %>
                  <span class="separator"> | </span>
                  <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/delete" method="post" style="display: inline;">
                    <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
                    <button type="submit" class="delete-link" onclick="return confirm('Supprimer ce post ?')">supprimer</button>
                  </form>
                <% end %>

            </div>

            <div class="post-description">
                <%= MyApp.Helpers.HtmlHelper.escape(@post.description) %>
            </div>

            <%= if @post.url do %>
                <div class="post-link">
                    <a href="<%= @post.url %>" target="_blank" rel="noopener"><%= @post.url %></a>
                </div>
            <% end %>

            <%= if @post.type == "lfg" do %>
                <div class="post-contact">
                    <strong>Contact:</strong> <%= MyApp.Helpers.HtmlHelper.escape(@post.contact) %>

                </div>
            <% end %>

            <%= if @post.tags && length(@post.tags) > 0 do %>
                <div class="post-tags">
                    <%= for tag <- @post.tags do %>
                        <span class="tag">
                            <%= MyApp.Helpers.HtmlHelper.escape(tag) %>
                        </span>
                    <% end %>
                </div>
            <% end %>
        </div>
    </article>
</section>

<!-- Formulaire nouveau commentaire -->
<section class="comment-form container">
    <%= if @current_user  do %>
        <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments" method="post">
            <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">

            <textarea name="body" rows="4" placeholder="Écrire un commentaire..." required></textarea>
            <button type="submit">Commenter</button>
        </form>
    <% else %>
     <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments" method="post">
            <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">

            <textarea name="body" rows="4" placeholder="Écrire un commentaire..." required></textarea>
            <button type="submit" style="opacity: 0.5; cursor: not-allowed;" disabled>Commenter</button>
        </form>
        <p><a href="/auth/login">Connectez-vous</a> pour commenter</p>
    <% end %>
</section>

<!-- Liste des commentaires -->
<section class="comments-list container">
    <h2 class="comments-list-title"><%= length(@comments) %> commentaire(s)</h2>

    <%= for comment <- @comments do %>
        <!-- Commentaire parent -->
        <article class="comment" data-comment-id="<%= comment.id %>">

            <div class="comment-vote">
              <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments/<%= comment.id %>/upvote" method="post">
                  <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
                  <button type="submit" class="vote-button <%= if MyApp.Services.VoteService.has_voted?(@current_user, "comment", comment.id), do: "voted" %>">▲</button>
              </form>
              <span class="vote-count"><%= comment.score %></span>
          </div>

            <div class="comment-content">
                <div class="comment-meta">
                    <span class="comment-author"><%= comment.user.username %></span>
                    <span class="comment-time"><%= comment.time_ago %></span>
                </div>

                <div class="comment-body">
                    <%= MyApp.Helpers.HtmlHelper.escape(comment.body) %>
                </div>

                <%= if @current_user  do %>
                    <button class="reply-button" data-js-reply-toggle data-comment-id="<%= comment.id %>">
                        répondre
                    </button>

                     <!-- AJOUTE: Bouton delete si c'est son commentaire -->
                    <%= if @current_user.id == comment.user_id do %>
                      <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments/<%= comment.id %>/delete" method="post" style="display: inline; margin-left: 0.5rem;">
                        <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
                        <button type="submit" class="delete-link" onclick="return confirm('Supprimer ce commentaire ?')">supprimer</button>
                      </form>
                    <% end %>

                    <!-- Formulaire de réponse (caché par défaut) -->
                    <div class="reply-form" data-js-reply-form data-comment-id="<%= comment.id %>" style="display:none">
                        <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments" method="post">
                            <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
                            <input type="hidden" name="parent_id" value="<%= comment.id %>">

                            <textarea name="body" rows="3" placeholder="Répondre..." required></textarea>
                            <button type="submit">Répondre</button>
                            <button type="button" data-js-reply-cancel data-comment-id="<%= comment.id %>">Annuler</button>
                        </form>
                    </div>
                <% end %>
            </div>
        </article>

        <!-- Replies (commentaires imbriqués) -->
        <%= if comment.replies && length(comment.replies) > 0 do %>
            <div class="replies">
                <%= for reply <- comment.replies do %>
                    <article class="comment reply" data-comment-id="<%= reply.id %>">

                        <div class="comment-vote">
                          <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments/<%= reply.id %>/upvote" method="post">
                              <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
                              <button type="submit" class="vote-button <%= if MyApp.Services.VoteService.has_voted?(@current_user, "comment", reply.id), do: "voted" %>">▲</button>
                          </form>
                          <span class="vote-count"><%= reply.score %></span>
                      </div>

                        <div class="comment-content">
                            <div class="comment-meta">
                                <span class="comment-author"><%= reply.user.username %></span>
                                <span class="comment-time"><%= reply.time_ago %></span>
                            </div>

                            <div class="comment-body">
                                <%= MyApp.Helpers.HtmlHelper.escape(reply.body) %>
                            </div>

                            <!-- AJOUTE: Bouton delete si c'est sa réponse -->
                            <%= if @current_user && @current_user.id == reply.user_id do %>
                              <form action="/g/<%= @game.slug %>/posts/<%= @post.id %>/comments/<%= reply.id %>/delete" method="post" style="display: inline;">
                                <input type="hidden" name="_csrf_token" value="<%= Plug.CSRFProtection.get_csrf_token() %>">
                                <button type="submit" class="delete-link" onclick="return confirm('Supprimer cette réponse ?')">supprimer</button>
                              </form>
                            <% end %>
                        </div>
                    </article>
                <% end %>
            </div>
        <% end %>
    <% end %>
</section>

</main>



<!-- JavaScript pour toggle formulaires de réponse -->
<script>
(function() {
  'use strict';

  document.addEventListener('DOMContentLoaded', function() {
    // Toggle reply forms
    const replyButtons = document.querySelectorAll('[data-js-reply-toggle]');
    const cancelButtons = document.querySelectorAll('[data-js-reply-cancel]');

    replyButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
        const form = document.querySelector('[data-js-reply-form][data-comment-id="' + commentId + '"]');

        if (form) {
          form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
      });
    });

    cancelButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        const commentId = button.getAttribute('data-comment-id');
        const form = document.querySelector('[data-js-reply-form][data-comment-id="' + commentId + '"]');

        if (form) {
          form.style.display = 'none';
        }
      });
    });
  });
})();
</script>

</body>
</html>
